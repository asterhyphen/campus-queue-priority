rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Each user can read/write ONLY their own user document (uid-based)
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      // Admins can read all users:
      allow read: if request.auth != null && request.auth.token.role == 'admin';
      // Writes by user to their own doc allowed, admins may update roles via server
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // Queues: readable by logged-in users; writes handled by Cloud Functions (admin-only)
    match /queues/{queueId} {
      allow get, list: if request.auth != null && request.auth.token.email_verified == true;
      // Admins can create/update queue docs
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'admin';

      // Tokens: READ allowed for cashier/admin and token owner; no direct client write
      match /tokens/{tokenId} {
        allow read: if request.auth != null &&
                    (request.auth.token.role == 'admin' ||
                     request.auth.token.email == get(/databases/$(database)/documents/queues/$(queueId)).data.cashierEmail ||
                     resource.data.uid == request.auth.uid);
        allow list: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.email == get(/databases/$(database)/documents/queues/$(queueId)).data.cashierEmail);
        allow create, update, delete: if false;
      }

      // Current token: read for cashier/admin and user, writes disallowed for clients
      match /current/{tokenDoc} {
        allow read: if request.auth != null &&
                    (request.auth.token.role == 'admin' ||
                     request.auth.token.email == get(/databases/$(database)/documents/queues/$(queueId)).data.cashierEmail ||
                     resource.data.uid == request.auth.uid);
        allow write: if false;
      }

      // noShows / audit: admin/cashier read, writes false for clients
      match /noShows/{doc} {
        allow read: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.email == get(/databases/$(database)/documents/queues/$(queueId)).data.cashierEmail);
        allow create, update, delete: if false;
      }

      match /audit/{doc} {
        allow read: if request.auth != null && request.auth.token.role == 'admin';
        allow write: if false;
      }
    }

    // Blocked users: readable by anyone (needed during login checks); only admins may write
    match /blockedUsers/{doc} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Rate limits: read only by the user, no client writes
    match /rateLimits/{uid} {
      allow get: if request.auth != null && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // Helper: fallback deny
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
